rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helper Functions ----------
    // Check if the user is the configured Super Admin
    function isSuperAdmin() {
      // A user is a super admin if their document in the 'admins' collection
      // has the role of 'superadmin'. This document must be created manually.
      let adminDoc = get(/databases/$(database)/documents/admins/$(request.auth.uid));
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             'role' in adminDoc.data &&
             adminDoc.data.role == 'superadmin';
    }

    // Check if the user is an approved Admin
    function isAdmin() {
      // An admin is a user whose document in the 'admins' collection
      // has the status of 'approved'.
      let adminDoc = get(/databases/$(database)/documents/admins/$(request.auth.uid));
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             'status' in adminDoc.data &&
             adminDoc.data.status == 'approved';
    }
    
    // ---------- Config Collection (No longer used for super admin check) ----------
    match /config/{docId} {
        allow read: if true;
        allow write: if false; // Should be managed from the Firebase Console
    }


    // ---------- Admins Collection ----------
    match /admins/{adminId} {
      allow read: if request.auth != null;               // Any logged-in user can read admin info
      allow create: if request.auth.uid == adminId;      // Only user can create their own admin doc
      allow update: if isSuperAdmin();                   // Only super admin can update status
      allow delete: if isSuperAdmin();                   // Only super admin can delete
    }

    // ---------- Users Collection ----------
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      // Saved Issues
      match /savedIssues/{issueId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Notifications
      match /notifications/{notificationId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if true; // Allow backend services/other users to create notifications
        allow update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---------- Anonymous Issues ----------
    match /anonymousIssues/{issueId} {
      allow read: if true;                   // Public can fetch
      allow create: if true;                 // Anyone can create anonymous issues
      allow update: if isAdmin() || isSuperAdmin(); // Admins or Super Admin can update status
      allow delete: if isSuperAdmin();       // Only super admin can delete

      // Votes on anonymous issues
      match /votes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---------- Profiled Issues ----------
    match /profiledIssues/{issueId} {
      allow read: if true;                   // Public can fetch issues
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.reporterId;

      // Admin can update status
      allow update: if isAdmin() || isSuperAdmin();

      // Reporter or super admin can delete
      allow delete: if request.auth != null &&
                    (request.auth.uid == resource.data.reporterId || isSuperAdmin());

      // Votes for profiled issues
      match /votes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
